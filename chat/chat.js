var AceCore=typeof exports=="undefined"?AceCore||{}:exports;void function(w){var k={};var f={};var b=false;var q=[];var d={format:function(z,y){return z.replace(/#\{(.*?)\}/g,function(B,A){return y&&(A in y)?y[A]:""})}};var s={};var u={};var x={log:function(y){}};function e(A,z){if(typeof z!="function"){return}if(A instanceof Array){var y=A.length;while(y--){e(A[y],z)}return}k[A]=k[A]||[];k[A].unshift(z)}function g(A,z){if(typeof z!="function"){return}if(A instanceof Array){var y=A.length;while(y--){g(A[y],z)}return}var B=k[A];if(!B){return}var y=B.length;while(y--){if(B[y]===z){B.splice(y,1)}}}function v(A,C){if(!b){q.push([A,C]);return}var B=k[A];if(!B){return}var z=B.length;while(z--){try{B[z](C,A)}catch(y){x.log([A,y.message].join(" : "))}}}function l(z){var y=u[z];return y&&y.instance}function p(y){return f[y]||{}}function j(z){var y=s[z];if(!y||y.instance||!y.creator){return}y.instance=y.creator({on:e,un:g,fire:v,getConfig:function(A){return function(B){return p(B||A)}}(z),getExtension:l,getLib:r,log:function(A){return function(B){x.log&&x.log([A,B].join(" : "))}}(z)});if(y.instance.init){y.instance.init()}}function o(z){var y=u[z];if(!y||y.instance||!y.creator){return}y.instance=y.creator({getConfig:function(A){return function(B){return p(B||A)}}(z),getExtension:l,getLib:r,log:function(A){return function(B){x.log&&x.log([A,B].join(" : "))}}(z)});if(y.instance.init){y.instance.init()}}function i(z){var y=s[z];if(!y||!y.instance){return}if(y.instance.destroy){y.instance.destroy()}y.instance=null}function t(z){var y=u[z];if(!y||!y.instance){return}if(y.instance.destroy){y.instance.destroy()}y.instance=null}function h(B,z){if(!z){return}var y=f[B]||{};for(var A in z){y[A]=z[A]}f[B]=y}function m(A,z){var y=s[A];if(y){return}s[A]={creator:z};b&&j(A)}function c(A,y){var z=u[A];if(z){return}u[A]={creator:y};b&&o(A)}function a(y){if(b){return}y=y||{};d=y.lib||d;x=y.logger||x;for(var A in u){o(A)}for(var A in s){j(A)}b=true;var z;while(z=q.shift()){v(z[0],z[1])}x.log&&x.log("core start.")}function n(){if(!b){return}for(var y in s){i(y)}for(var y in u){t(y)}b=false;x.log&&x.log("core stop.")}function r(){return d}w.addConfig=h;w.addModule=m;w.addExtension=c;w.start=a;w.stop=n}(AceCore);var AceTemplate=typeof exports!="undefined"?exports:AceTemplate||{};void function(d){var f={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};var c={'"':"quot","<":"lt",">":"gt","&":"amp"," ":"nbsp"};var g={g:function(h){if(typeof h!="string"){return h}return document.getElementById(h)},decodeHTML:function(h){return String(h).replace(/&(quot|lt|gt|amp|nbsp);/ig,function(j,i){return f[i]}).replace(/&#u([a-f\d]{4});/ig,function(i,j){return String.fromCharCode(parseInt("0x"+j))}).replace(/&#(\d+);/ig,function(i,j){return String.fromCharCode(+j)})},encodeHTML:function(h){return String(h).replace(/["<>& ]/g,function(i){return"&"+c[i]+";"})},elementText:function(h){if(!h||!h.tagName){return""}if(/^(input|textarea)$/i.test(h.tagName)){return h.value}return g.decodeHTML(h.innerHTML)}};var a={};var e=false;function b(j){var i=[],k=[];i.push("with(this){");i.push(j.replace(/<(script|style)[^>]*>[\s\S]*?<\/\1>/g,function(l){return['!#{decodeURIComponent("',encodeURIComponent(l),'")}'].join("")}).replace(/[\r\n]+/g,"\n").replace(/^\n+|\s+$/mg,"").replace(/((^\s*[<>!#^&\u0000-\u0008\u007F-\uffff].*$|^.*[<>]\s*$|^(?!\s*(else|do|try|finally)\s*$)[^'":;{}()]+$|^(\s*(([\w-]+\s*=\s*"[^"]*")|([\w-]+\s*=\s*'[^']*')))+\s*$|^\s*([.#][\w-.]+(:\w+)?(\s*|,))*(?!(else|do|while|try|return)\b)[.#]?[\w-.*]+(:\w+)?\s*\{.*$)\s?)+/mg,function(l){l=['"',l.replace(/&none;/g,"").replace(/["'\\]/g,"\\$&").replace(/\n/g,"\\n").replace(/(!?#)\{(.*?)\}/g,function(p,m,o){o=o.replace(/\\n/g,"\n").replace(/\\([\\'"])/g,"$1");var n=/^[a-z$][\w+$]+$/i.test(o)&&!(/^(true|false|NaN|null|this)$/.test(o));return['",',n?["typeof ",o,'=="undefined"?"":'].join(""):"",(m=="#"?"_encode_":""),"(",o,'),"'].join("")}),'"'].join("").replace(/^"",|,""$/g,"");if(l){return["_output_.push(",l,");"].join("")}else{return""}}));i.push("}");var h=new Function("_output_","_encode_","helper",i.join(""));return h}d.format=function(m,l,k){if(!m){return""}var h,j;if(typeof m=="object"&&m.tagName){j=m;m=j.getAttribute("id")}k=k||this;h=a[m];if(!h){if(!/[^\w-]/.test(m)){if(!j){j=g.g(m)}h=this.register(m,j)}else{h=b(m)}}var i=[];h.call(l||"",i,g.encodeHTML,k);return i.join("")};d.register=function(m,l){if(!arguments.length&&!e){e=true;var h=document.getElementsByTagName("script");for(var k=0;k<h.length;k++){var j=h[k];if(/^(text\/template)$/i.test(j.getAttribute("type"))){var m=j.getAttribute("id");m&&arguments.callee.call(this,m,j)}}}if(!m){return}if(a[m]){return a[m]}if(typeof l!="string"){if(typeof l=="undefined"){l=g.g(m)}l=g.elementText(l)}return a[m]=b(l)};d.unregister=function(h){delete a[h]}}(AceTemplate);var AceEvent=AceEvent||{};void function(b){var f={g:function(g){if(typeof g!="string"){return g}return document.getElementById(g)},on:function(h,g,i){h=f.g(h);if(!h){return}if(h.addEventListener){h.addEventListener(g,i,false)}else{h.attachEvent&&h.attachEvent("on"+g,i)}},un:function(h,g,i){h=f.g(h);if(!h){return}if(h.removeEventListener){h.removeEventListener(g,i,false)}else{h.detachEvent&&h.detachEvent("on"+g,i)}},each:function(g,h){if(!g||!h){return}for(var j=0;j<g.length;j++){if(h(g[j],j)===false){return}}}};var e={};var a=["mousedown","click","dblclick"];var c=0;function d(h,g){if(!h||!g){return}while(h&&!/^html$/i.test(h.tagName)){if(g(h)==false){return}h=h.parentNode}}b.on=function(h,j,g){if(!j){return}h=f.g(h);if(!h){return}g=g||a;if(!(g instanceof Array)){g=[g]}if(!g.length){return}c++;var i=e[c]={target:h,events:{},callback:j};f.each(g,function(k){if(i.events[k]){return}i.events[k]=function(m){m=m||event;var l=m.srcElement||m.target;if(/^(html|document)$/i.test(l.tagName)){l=document.body}d(l,function(n){if(h.parentNode==n){return false}if(!n.getAttribute){return}var o=n.getAttribute("event-"+k);if(!o){switch(k){case"click":o=n.getAttribute("cmd");break;case"mousedown":o=n.getAttribute("down");break;case"contextmenu":o=n.getAttribute("menu");break}}if(!o){return}j(o,n,m);return false})};f.on(h,k,i.events[k])});return c};b.fire=function(i,k,g,j){var h=e[i];h&&h.callback(k,g,j)};b.un=function(i){var h=e[i];if(!h){return}for(var g in h.events){f.un(h.target,g,h.events[g])}delete e[i]}}(AceEvent);var AceTree=AceTree||{};void function(f){var k={g:function(p){if(typeof p!="string"){return p}return document.getElementById(p)},remove:function(p){p=this.g(p);if(!p){return}p.parentNode.removeChild(p)},addClass:function(p,q){i(p,"class",q)},removeClass:function(p,q){j(p,"class",q)},each:function(r,q){if(!r||!q){return}for(var p=0;p<r.length;p++){if(q(r[p],p)===false){break}}},getKeys:function(s){var q=[];for(var r in s){q.push(r)}return q}};function a(q,r){q=k.g(q);r=k.g(r);if(q==r){return true}var p;d(r,function(s){if(q==s){p=false;return false}});return p}function b(q,p){q=k.g(q);if(!q){return}q.removeAttribute("id");q.parentNode.insertBefore(e(p),q);q.parentNode.removeChild(q)}function g(q,p){q=k.g(q);console.log("1");if(!q){return}console.log("2");console.log(p);q.appendChild(e(p))}function i(r,q,t){r=k.g(r);if(!r||!r.getAttribute||!r.setAttribute){return}var s=r.getAttribute(q);if(s){var p=s.indexOf(t);while(p>=0){if(/^\s*$/.test(s.charAt(p-1)+s.charAt(p+t.length))){return}p=s.indexOf(t,p+1)}s+=" "+t}else{s=t}r.setAttribute(q,s)}function j(r,q,t){r=k.g(r);if(!r||!r.getAttribute||!r.setAttribute){return}var s=r.getAttribute(q);if(!s){return}var p=s.indexOf(t);while(p>=0){if(/^\s*$/.test(s.charAt(p-1)+s.charAt(p+t.length))){r.setAttribute(q,s.substring(0,p)+s.substring(p+t.length));return}p=s.indexOf(t,p+1)}}function d(q,p){q=k.g(q);if(!q||!p){return}while(q&&!/^html$/i.test(q.tagName)){if(p(q)==false){return}q=q.parentNode}}var o={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};o.optgroup=o.option;o.tbody=o.tfoot=o.colgroup=o.caption=o.thead;o.th=o.td;function e(s){var q=document.createDocumentFragment();if(!s){return q}s=s.replace(/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,"<$1></$2>");var p=(s.match(/<([\w:]+)/)||["",""])[1].toLowerCase(),t=o[p]||o._default,r=t[0],u=document.createElement("div");u.innerHTML=[t[1],s,t[2]].join("");while(r--){u=u.lastChild}while(u.childNodes.length){q.appendChild(u.childNodes[0])}return q}var n={};var m=0;function l(p,q){this.parentNode=p;this.tree=p.tree;this.layer=p.layer+1;this.id=q[this.tree.fieldIdentifier];this.did=[this.tree.didPrefix,this.tree.handler,this.id].join("-");this.cid=[this.tree.didPrefix,this.tree.handler,this.id,"childs"].join("-");n[this.did]=this;this.data=q;this.status={};this.childNodes=[];if(this.tree.oncreated){this.tree.oncreated(this)}}l.prototype.remove=function(q){if(this.tree.focusDid==this.did){this.tree.focusDid=""}this.removeAll(true);delete n[this.did];if(q){return}this.parentNode.childNodes=[].concat(this.parentNode.childNodes.slice(0,this.index),this.parentNode.childNodes.slice(this.index+1));for(var p=this.index;p<this.parentNode.childNodes.length;p++){this.parentNode.childNodes[p].index=p}if(this.tree.onsort){this.parentNode.refresh()}else{!a(this.did,this.cid)&&k.remove(this.cid);k.remove(this.did)}};l.prototype.appendChild=function(q,r){if(!q){return}if(typeof r=="undefined"){r=true}var p=new l(this,q);p.index=this.childNodes.length;this.childNodes.push(p);if(r){p.loadChilds(q[this.tree.fieldChilds],true)}if(this.tree.onsort){this.childNodes.sort(this.tree.onsort);b(this.did,this.reader())}else{g(this.cid,p.reader())}return p};l.prototype.appendChilds=function(p,t){if(!p){return}if(typeof t=="undefined"){t=true}var r=this;var q=[];k.each(p,function(v){var u=new l(r,v);q.push(u);u.index=r.childNodes.length;r.childNodes.push(u);if(t){u.loadChilds(v[r.tree.fieldChilds],true)}});if(this.tree.onsort){this.tree.onsort&&this.childNodes.sort(this.tree.onsort);this.refresh()}else{var s=[];k.each(q,function(u){s.push(u.reader())});g(this.cid,s.join(""))}return q};l.prototype.sort=function(r,q){if(!this.tree.onsort){return}this.childNodes.sort(this.tree.onsort);var p;k.each(this.childNodes,function(t,s){if(t.index!=s){t.index=s;p=true}if(r&&t.sort(true,true)){p=true}});if(p&&!q){this.refresh()}return p};l.prototype.updateData=function(q,t){if(!q){return}var s=false;for(var r in q){if(this.data[r]!==q[r]){this.data[r]=q[r];s=true}}if(t){this.loadChilds(q[this.tree.fieldChilds],true)}if(s){this.refresh()}};l.prototype.reader=function(){if(!this.tree.onreader){return""}var q=[];k.each(this.childNodes,function(r){q.push(r.reader())});if(this==this.tree){return q.join("")}var p=this;return this.tree.onreader(this).replace(/(^\s*<\w+)([^>]*>)([\s\S]*$)/,function(s,r,u,t){t=t.replace(/(<\w+\b[^>]*)(\bdata-type="childs"[^>]*>)(\s*<\/\w+>)/,function(w,v,y,x){if(!q.length){return""}return[v,' id="',p.cid,'"',y,q.join(""),x].join("")});return[r,' id="',p.did,'"',u,t].join("")})};l.prototype.removeAll=function(p){k.each(this.childNodes,function(q){q.remove(true)});this.childNodes=[];if(p){return}this.refresh()};l.prototype.loadChilds=function(p,r){if(this.childNodes.length==0&&p&&p.length==0){return}this.removeAll(true);if(!p){return}var q=this;k.each(p,function(t){var s=new l(q,t);q.childNodes.push(s);s.loadChilds(t[q.tree.fieldChilds],true)});this.tree.onsort&&this.childNodes.sort(this.tree.onsort);k.each(this.childNodes,function(t,s){t.index=s});!r&&this.refresh()};l.prototype.each=function(q){var p;q&&k.each(this.childNodes,function(r){result=q(r)||r.each(q);if(p===false){return p}});return p};l.prototype.setStatus=function(p,q,r){if(!p){return}if(this.status[p]==q){return}this.status[p]=q;if(r){return}if(this.tree.statusClasses instanceof RegExp){if(this.tree.statusClasses.test(p)){if(q){k.addClass(this.did,p);this.tree.childsClasses.test(p)&&k.addClass(this.cid,p)}else{k.removeClass(this.did,p);this.tree.childsClasses.test(p)&&k.removeClass(this.cid,p)}return}}if(typeof this.tree.statusClasses=="object"){var s=this.tree.statusClasses[p];if(s){if(s instanceof Array){if(q){k.addClass(this.did,s[0]);k.removeClass(this.did,s[1])}else{k.addClass(this.did,s[1]);k.removeClass(this.did,s[0])}}else{if(q){k.addClass(this.did,s)}else{k.removeClass(this.did,s)}}return}}this.refresh()};l.prototype.getStatus=function(p){return this.status[p]};l.prototype.getClasses=function(r){var q=[];for(var s in this.status){if(!this.tree.statusClasses.test(s)){continue}if(this.status[s]&&(!r||this.tree.childsClasses.test(s))){q.push(s)}}return q.join(" ")};l.prototype.refresh=function(){if(this==this.tree){this.parent.innerHTML=l.prototype.reader.call(this);return}!a(this.did,this.cid)&&k.remove(this.cid);b(this.did,this.reader())};l.prototype.expand=function(){this.setStatus("expand",true)};l.prototype.collapse=function(){this.setStatus("expand",false)};l.prototype.toggle=function(){this.setStatus("expand",!this.getStatus("expand"))};l.prototype.nextNode=function(){if(this.childNodes.length&&this.getStatus("expand")){return this.childNodes[0]}return this.parentNode.childNodes[this.index+1]};l.prototype.previousNode=function(){if(!this.index){if(this.parentNode==this.tree){return}return this.parentNode}return this.parentNode.childNodes[this.index-1]};l.prototype.focus=function(p){this.tree.setFocused(this,p)};var c={didPrefix:"node",fieldIdentifier:"id",fieldChilds:"nodes",statusClasses:/^(focus|hover|select|expand)$/,childsClasses:/^(expand)$/};function h(q){q=q||{};for(var r in c){!(r in q)&&(q[r]=c[r])}for(var r in q){this[r]=q[r]}this.tree=this;this.layer=0;this.index=0;this.handler=m++;this.childNodes=[];this.focusDid="";this.cid=this.parent;i(this.parent,"data-handler",this.handler);if(this.oninit){this.oninit(this)}}h.prototype.loadChilds=function(p,q){if(this.childNodes.length==0&&p&&p.length==0){return}q&&this.saveStatus();l.prototype.loadChilds.call(this,p,true);q&&this.restoreStatus();this.refresh()};h.prototype.appendChild=function(p,q){return l.prototype.appendChild.call(this,p,q)};h.prototype.appendChilds=function(p,q){return l.prototype.appendChilds.call(this,p,q)};h.prototype.updateData=function(q,r){if(!q){return}var p=this.node4data(q);p&&p.updateData(q,r);return p};h.prototype.sort=function(p){l.prototype.sort.call(this,true,p||typeof p=="undefiend")};h.prototype.refresh=function(){l.prototype.refresh.call(this)};h.prototype.removeAll=function(){if(!this.childNodes.length){return}l.prototype.removeAll.call(this);this.refresh()};h.prototype.removeNode=function(q){if(!q){return}var p=this.node4data(q);p&&p.remove()};h.prototype.setFocused=function(r,p){if(!r){return}var q=this.node4data(r);if(!q||q.did==this.focusDid){return}var s=n[this.focusDid];s&&s.setStatus("focus",false);q&&q.setStatus("focus",true);if(p){var t=k.g(q.did);t&&t.scrollIntoView(p==1)}this.focusDid=q.did;if(this.onfocus){this.onfocus(q)}};h.prototype.getFocused=function(){return n[this.focusDid]};h.prototype.node4data=function(q){if(!q){return}if(q instanceof l&&q.tree==this){return q}var r=typeof q=="string"?q:q[this.fieldIdentifier];var p=[this.didPrefix,this.handler,r].join("-");if(n[p]){return n[p]}};h.prototype.node4target=function(q){var p=AceTree.node4target(q);if(!p||p.tree!=this){return}return p};h.prototype.each=function(p){return l.prototype.each.call(this,p)};h.prototype.saveStatus=function(){var p={};this.status=p;this.each(function(q){p[q.did]=q.status})};h.prototype.restoreStatus=function(){if(!this.status){return}var p=this.status;this.each(function(q){if(q.did in p){q.status=p[q.did]}});this.status=null};f.create=function(p){return new h(p)};f.node4target=function(q){var p;q=k.g(q);d(q,function(r){var s=n[r.id];if(s){p=s;return false}});return p}}(AceTree);var ChannelCommon=typeof exports=="undefined"?ChannelCommon||{}:exports;void function(a){function c(f,e){if(!e){return f}return f.replace(/\#\{(.+?)\}/g,function(){return e[arguments[1]]})}function d(e,h){if(e instanceof Array){for(var f=0;f<e.length;f++){if(h(e[f],f)===false){return false}}}else{if(typeof e=="object"){for(var g in e){if(h(e[g],g)===false){return false}}}}}var b={maxNick:20,maxWeibo:150,maxLetter:4000,maxTalk:2000,checkNick:function(e){if(!e||/^\s+$/.test(e)){return"昵称不能为空"}if(e.length>this.maxNick){return this.format("昵称长度不能超过#{0}",[this.maxNick])}if(/@/.test(e)){return"昵称不能带@"}},checkWeibo:function(e){if(/^\s+$/.test(e)){return"微博不能为空"}if(!e){return}if(e.length>this.maxWeibo){return this.format("昵称长度不能超过#{0}",[this.maxWeibo])}if(!(/^http:\/\/(weibo\.com|t\.qq\.com|t\.163\.com)\/\w+$/.test(e))){return"微博格式不正确，仅只支持：http://weibo.com|http://t.qq.com|http://t.163.com"}},checkLetter:function(e){if(!e||/^\s+$/.test(e)){return"私信不能为空"}if(e.length>this.maxLetter){return this.format("私信长度不能超过#{0}",[this.maxLetter])}},checkTalk:function(e){if(!e||/^\s+$/.test(e)){return"对话内容不能为空"}if(e.length>this.maxTalk){return this.format("对话内容长度不能超过#{0}",[this.maxTalk])}},format:c,forEach:d};d(b,function(f,e){a[e]=f})}(ChannelCommon);AceCore.addConfig("ChatApi",{pickMaxWait:45*1000,apiHost:"http://renrousousuo.com:8080"});if(/debug/.test(location)){AceCore.addConfig("ChatApi",{apiHost:"http://localhost:2012"})}AceCore.addExtension("ChatApi",function(a){var f=a.getLib();var b=a.getConfig();function e(j){var h=[];for(var i in j){h.push([encodeURIComponent(i),encodeURIComponent(j[i])].join("="))}return h.join("&")}function g(i){var h={};String(i).replace(/([^?&#]+)=([^?&#]*)/g,function(k,j,l){h[j]=l});return h}var d=g(document.location.search);var c=d.api?"http://"+d.api:b.apiHost;return{getApiHost:function(){return c},hello:function(j){if(!j){return}var i=setTimeout(function(){i=0;j({result:"overtime"});j=function(){}},b.pickMaxWait);var h=c+"/hello";a.log(h);f.sio.callByServer(h,function(k){i&&clearTimeout(i);i=0;j(k)})},pick:function(i,k){if(!i||!k){return}var j=setTimeout(function(){j=0;k({result:"overtime"});k=function(){}},b.pickMaxWait);var h=[c+"/pick",e(i)].join("?");a.log(h);f.sio.callByServer(h,function(l){j&&clearTimeout(j);j=0;k(l)})},command:function(i,j){if(!i){return}var h=[c+"/command",e(i)].join("?");a.log(h);f.sio.callByServer(h,function(k){j&&j(k)})}}});AceCore.addConfig("Events",{pickSuccess:1,showDialog:2,playerFocus:3,letterDialog:4,viewLetter:5,nick:6,talk:7,xgame:8,weibo:9,move:10,role:11});AceCore.addModule("Manager",function(n){var o=n.getConfig("Events");var k=n.getLib();var e=n.getExtension("ChatApi");var h;var p=0;function g(){e.pick({channel:h,seq:p},function(q){if(!q||q.result!="ok"){n.log(q);if(!q||q.result=="overtime"||(q.result!="kill"&&q.channel==h)){g()}return}if(q.channel==h&&p==q.currSeq){if("nextSeq" in q){p=q.nextSeq;n.log("seq change to:"+p)}if("fields" in q){n.fire(o.pickSuccess,q.fields)}setTimeout(function(){g()},100)}})}function c(q){if(q==h){return}e.command({channel:h,desc:q,command:"goto"});h=q;m()}function m(){e.command({channel:h,command:"enter",refer:document.referrer},function(q){q=q||{};if(q.result!="ok"){n.fire(o.showDialog,{type:"error",message:q.error||"enter channel error."});return}p=0;setTimeout(function(){g()},0)})}function a(q){e.command({channel:h,command:"nick",nick:q},j)}function b(q){e.command({channel:h,command:"weibo",weibo:q},j)}function f(q){e.command({channel:h,command:"talk",text:q},function(r){if(!r||r.result!="ok"){return}r.error&&n.fire(o.showDialog,{type:"error",message:r.error});k.g("editor").value=""})}function d(q){e.command({channel:h,command:"vote",id:q},j)}function j(q){q.error&&n.fire(o.showDialog,{type:"error",message:q.error})}function l(){function u(){}var s=0;function q(){if(s){return}s=1;v.submit()}var v=document.createElement("form");v.action=e.getApiHost()+"/command";v.method="POST";v.target=r;v.enctype="application/x-www-form-urlencoded";document.body.appendChild(v);var t=document.createElement("iframe");var r="_safariPassportFrame_"+(+new Date).toString(36);t.name=r;t.onload=q;t.src=e.getApiHost()+"/command";document.body.appendChild(t)}function i(){e.hello(function(q){if(q&&q.passport){m()}else{n.fire(o.showDialog,{type:"passport",url:e.getApiHost()+"/passport",onclose:function(){setTimeout(function(){i()},2000)}})}})}return{init:function(){n.on(o.nick,a);n.on(o.talk,f);n.on(o.xgame,d);n.on(o.weibo,b);AceTemplate.register();k.on(window,"hashchange",function(){c(location.hash.replace(/^#/,""))});h=location.hash.replace(/^#/,"");if(/safari/i.test(navigator.userAgent)){i()}else{m()}}}});AceCore.addModule("MessageBox",function(f){var h=f.getConfig("Events");var d=f.getLib();var e;var b={};function i(j){d.each(j,function(k){switch(k.type){case"passport":b=k.info;break;case"messageAll":e.loadChilds(k.messages);a();break;case"messageAdd":e.appendChilds(k.messages);a();break}})}function a(){var j=e.parent.parentNode;j.scrollTop=j.scrollHeight}function g(k){k=new Date(k);var l=d.date.format(k,"HH:mm:ss");var j=d.date.format(k,"yyyy-MM-dd");return d.date.format(new Date,"yyyy-MM-dd")==j?l:[j,l].join(" ")}function c(j){return d.encodeHTML(j).replace(/\n/g,"<br/>")}return{init:function(){e=AceTree.create({parent:d.g("messageListTemplate").parentNode,oninit:function(j){j.eventHandler=AceEvent.on(j.parent,function(n,k,m){var l=j.node4target(k);l&&j.oncommand(n,l,m)})},onreader:function(j){return AceTemplate.format("messageListTemplate",j.data,{node:j,formatTime:g,mutiline:c})},oncommand:function(l,j,k){switch(l){case"letter":f.fire(h.letterDialog,{nick:j.data.nick,to:j.data.from});break}},statusClasses:/^(focus|hover|select|expand|self)$/,oncreated:function(j){j.setStatus("self",j.data.from==b.id,true)}});f.on(h.pickSuccess,i)}}});AceCore.addModule("PlayerBox",function(a){var c=a.getConfig("Events");var e=a.getLib();var b;var f={};function d(g){e.each(g,function(h){switch(h.type){case"passport":f=h.info;break;case"playerAll":b.loadChilds(h.players);break;case"playerAdd":b.appendChilds(h.players);break;case"playerUpdate":e.each(h.players,function(i){var j=b.updateData(i);if(f.id==i.id){f.nick=j.data.nick}});break;case"playerRemove":e.each(h.players,function(i){b.removeNode(i)});break}})}return{init:function(){b=AceTree.create({parent:e.g("playerListTemplate").parentNode,oninit:function(g){g.eventHandler=AceEvent.on(g.parent,function(k,j,i){var h=g.node4target(j);h&&g.oncommand(k,h,i)})},onreader:function(g){return AceTemplate.format("playerListTemplate",g.data,{node:g})},oncommand:function(i,g,h){switch(i){case"focus":g.focus();a.fire(c.playerFocus,{info:g.data});break;case"letter":a.fire(c.letterDialog,{nick:g.data.nick,to:g.data.id});break}},statusClasses:/^(focus|hover|select|expand|self)$/,oncreated:function(g){g.setStatus("self",g.data.id==f.id,true)}});a.on(c.pickSuccess,d);AceEvent.on("playerTools",function(g){switch(g){case"nick":a.fire(c.showDialog,{type:"nick",maxNick:ChannelCommon.maxNick,nick:f.nick,oncommand:function(k,j){if(k!="ok"){return}var h=e.g("inputNick").value;var i=ChannelCommon.checkNick(h);if(i){a.fire(c.showDialog,{type:"error",message:i});return true}if(h!=j.nick){a.fire(c.nick,h)}},onshow:function(i){var h=e.g("inputNick");h.setSelectionRange(0,h.value.length);h.focus()}});break;case"weibo":a.fire(c.showDialog,{type:"weibo",maxWeibo:ChannelCommon.maxWeibo,weibo:f.weibo||"http://weibo.com/",oncommand:function(k,i){if(k!="ok"){return}var j=e.g("inputWeibo").value;var h=ChannelCommon.checkWeibo(j);if(h){a.fire(c.showDialog,{type:"error",message:h});return true}if(j!=i.weibo){a.fire(c.weibo,j)}},onshow:function(j){var h=e.g("inputWeibo");var i=h.value.length;h.setSelectionRange&&h.setSelectionRange(i,i);h.focus()}});break;case"viewLetter":a.fire(c.viewLetter);break}})}}});AceCore.addModule("EditorBox",function(a){var b=a.getConfig("Events");var c=a.getLib();return{init:function(){var d=AceEvent.on("editorTools",function(j,g,h){switch(j){case"send":var i=c.g("editor").value;var f=ChannelCommon.checkTalk(i);if(f){a.fire(b.showDialog,{type:"error",message:f});return true}a.fire(b.talk,i);break;case"focus":c.g("editor").focus();break}});c.on("editor","keydown",function(f){switch(f.which||f.keyCode||f.charCode){case 13:if(!(c.g("ctrlEnter").checked^f.ctrlKey)){c.event.stop(f);AceEvent.fire(d,"send")}break}})}}});AceCore.addModule("DialogBox",function(b){var d=b.getConfig("Events");var f=b.getLib();var e=0;function a(g){g._handler=e++;dialogTree.appendChild(g);g.onshow&&g.onshow(g)}function c(g){dialogTree.removeNode(g);g.onclose&&g.onclose(g)}return{init:function(){dialogTree=AceTree.create({fieldIdentifier:"_handler",parent:f.g("dialogTemplate").parentNode,oninit:function(g){g.eventHandler=AceEvent.on(g.parent,function(k,h,j){var i=g.node4target(h);i&&g.oncommand(k,i,j)})},onreader:function(g){return AceTemplate.format("dialogTemplate",g.data)},oncommand:function(j,h,i){var g=h.data.oncommand&&h.data.oncommand(j,h.data);if(!g){c(h.data)}}});b.on(d.showDialog,a)}}});AceCore.addModule("LetterBox",function(k){var m=k.getConfig("Events");var h=k.getLib();var b={};var f=k.getExtension("ChatApi")||k.getExtension("ZhouziApi");var g;function n(o){h.each(o,function(p){switch(p.type){case"passport":b=p.info;break;case"letterAll":g.loadChilds(p.messages);g.each(function(q){q.setStatus("old",q.data.time<p.lastView)});e();a();break;case"letterAdd":g.appendChilds(p.messages);a();e();break}})}function a(){var o=g.parent.parentNode;o.scrollTop=o.scrollHeight}var i=0;function e(){i=0;g.each(function(o){if(!o.getStatus("old")){i++}});h.g("newLetterNumber").innerHTML=i?"(<b>"+i+"</b>)":""}function l(p){p=new Date(p);var q=h.date.format(p,"HH:mm:ss");var o=h.date.format(p,"yyyy:MM:dd");return h.date.format(new Date,"yyyy:MM:dd")==o?q:[o,q].join(" ")}function c(o){return h.encodeHTML(o).replace(/\n/g,"<br/>")}function d(o){k.fire(m.showDialog,{type:"letter",nick:o.nick,to:o.to,oncommand:function(s,r){if(s!="ok"){return}var q=h.g("inputLetter").value;var p=ChannelCommon.checkLetter(q);if(p){k.fire(m.showDialog,{type:"error",message:p});return true}f.command({command:"letter",to:r.to,text:q})},onshow:function(q){var p=h.g("inputLetter");p.setSelectionRange(0,p.value.length);p.focus()}})}function j(){h.removeClass("letterBox","hidden");if(!i){return}f.command({command:"viewLetter"})}return{init:function(){g=AceTree.create({parent:h.g("letterListTemplate").parentNode,oninit:function(o){o.eventHandler=AceEvent.on(o.parent,function(s,p,r){var q=o.node4target(p);q&&o.oncommand(s,q,r)})},onreader:function(o){return AceTemplate.format("letterListTemplate",o.data,{node:o,formatTime:l,mutiline:c})},oncommand:function(q,o,p){switch(q){case"reply":k.fire(m.letterDialog,{nick:o.data.nick,to:o.data.from});break}},statusClasses:/^(focus|hover|select|expand|old|self)$/,oncreated:function(o){o.setStatus("self",o.data.from==b.id,true)}});k.on(m.letterDialog,d);k.on(m.pickSuccess,n);k.on(m.viewLetter,j);AceEvent.on("letterBox",function(o){switch(o){case"ok":case"cancel":h.addClass("letterBox","hidden");if(!i){return}g.each(function(p){p.setStatus("old",true)});e();break}})}}});AceCore.addModule("XGameBox",function(b){var c=b.getConfig("Events");var e=b.getLib();var a;var f={};function d(g){e.each(g,function(h){switch(h.type){case"passport":f=h.info;break;case"xgameAll":a.loadChilds(h.votes);break;case"xgameUpdate":e.each(h.votes,function(j){var i=a.updateData(j)});break}})}return{init:function(){a=AceTree.create({parent:e.g("xgameListTemplate").parentNode,oninit:function(g){g.eventHandler=AceEvent.on(g.parent,function(k,j,i){var h=g.node4target(j);h&&g.oncommand(k,h,i)})},onreader:function(g){return AceTemplate.format("xgameListTemplate",g.data,{node:g})},oncommand:function(i,g,h){switch(i){case"vote":if(g.data.voted){return}g.tree.each(function(j){j.data.voted=true});g.tree.refresh();b.fire(c.xgame,g.data.id);break}},statusClasses:/^(focus|hover|select|expand|self)$/});b.on(c.pickSuccess,d)}}});